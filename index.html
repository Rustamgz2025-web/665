<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cargo 665 | Bilingual Logistics Calculator | 货运计算器</title>
    <style>
        :root {
            --primary: #1a1a1a;
            --accent: #f39c12;
            --accent-hover: #e67e22;
            --bg-body: #f1f2f6;
            --bg-card: #ffffff;
            --text-main: #2c3e50;
            --text-light: #7f8c8d;
            --border-color: #dcdde1;
            --success: #27ae60;
            --danger: #e74c3c;
            --shadow: 0 10px 30px rgba(0,0,0,0.1);
            --radius: 16px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "PingFang SC", "Microsoft YaHei", sans-serif;
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            line-height: 1.5;
            padding-bottom: 50px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        header {
            background: var(--primary);
            width: 100%;
            margin-bottom: 40px;
            border-bottom: 4px solid var(--accent);
            position: relative;
            overflow: hidden;
        }

        .banner-wrapper {
            width: 100%;
            max-height: 400px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--primary);
        }

        .banner-image {
            width: 100%;
            height: auto;
            display: block;
            object-fit: cover;
            object-position: center;
        }

        /* Responsive Banner */
        @media (max-width: 1400px) { .banner-wrapper { max-height: 350px; } }
        @media (max-width: 992px) { .banner-wrapper { max-height: 300px; } }
        @media (max-width: 768px) { .banner-wrapper { max-height: 200px; } }
        @media (max-width: 480px) { .banner-wrapper { max-height: 150px; } }

        .cn {
            display: inline-block;
            font-size: 0.9em;
            color: #95a5a6;
            margin-left: 5px;
        }
        
        h2 .cn {
             display: block;
             color: var(--accent);
             font-size: 0.7em;
             margin-top: 5px;
             margin-left: 0;
        }

        .app-grid {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 30px;
        }

        @media (max-width: 992px) { .app-grid { grid-template-columns: 1fr; } }

        .card {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 35px;
            box-shadow: var(--shadow);
        }

        h2 {
            margin-bottom: 30px;
            font-size: 1.5rem;
            border-left: 5px solid var(--accent);
            padding-left: 15px;
        }

        .form-group { margin-bottom: 25px; }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 700;
            font-size: 0.95rem;
        }

        .input-box {
            position: relative;
            display: flex;
            align-items: center;
        }

        input, select {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid #edf2f7;
            border-radius: 12px;
            font-size: 1rem;
            outline: none;
            transition: all 0.3s ease;
            background: #f8fafc;
        }

        input:focus, select:focus {
            border-color: var(--accent);
            background: white;
            box-shadow: 0 0 0 4px rgba(243, 156, 18, 0.1);
        }

        .unit {
            position: absolute;
            right: 18px;
            font-weight: 600;
            color: var(--text-light);
            pointer-events: none;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .result-panel {
            background: var(--primary);
            color: white;
            position: sticky;
            top: 30px;
            display: flex;
            flex-direction: column;
        }

        .total-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--accent);
            margin-bottom: 5px;
        }

        .total-amount {
            font-size: 3rem;
            font-weight: 900;
            margin-bottom: 25px;
            color: #fff;
        }

        .breakdown {
            border-top: 1px solid rgba(255,255,255,0.1);
            padding-top: 25px;
        }

        .row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            font-size: 0.95rem;
        }

        .row .val {
            font-weight: 700;
            color: var(--accent);
        }

        .row .lbl {
            color: #bdc3c7;
        }

        .btn-print {
            background: var(--accent);
            color: var(--primary);
            border: none;
            padding: 18px;
            border-radius: 12px;
            font-weight: 800;
            font-size: 1.1rem;
            cursor: pointer;
            margin-top: 20px;
            transition: transform 0.2s, background 0.3s;
            text-transform: uppercase;
        }

        .btn-print:hover {
            background: var(--accent-hover);
            transform: translateY(-2px);
        }

        .checkbox-card {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 10px;
        }

        .check-item {
            border: 2px solid #edf2f7;
            padding: 12px;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: 0.2s;
        }

        .check-item:hover { border-color: var(--accent); }
        .check-item input { width: auto; }

        .ins-hidden { display: none; }
        
        /* --- Styles for Bilingual Insurance Info --- */
        .ins-info-box {
            margin-top: 15px;
            border: 1px solid #dcdde1;
            border-radius: 12px;
            overflow: hidden;
            background: #fff;
        }
        
        .ins-info-box summary {
            background: #f8fafc;
            padding: 15px 20px;
            cursor: pointer;
            font-weight: 700;
            list-style: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--text-main);
            transition: background 0.2s;
        }
        
        .ins-info-box summary:hover {
            background: #f1f2f6;
        }

        .ins-info-box summary::after {
            content: "Показать условия / 显示条款 +";
            font-size: 0.85rem;
            color: var(--accent);
            font-weight: bold;
        }
        
        .ins-info-box[open] summary::after {
            content: "Скрыть / 隐藏 -";
            color: var(--text-light);
        }
        
        .ins-content {
            padding: 0;
            background: white;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .ins-split {
            display: grid;
            grid-template-columns: 1fr 1fr;
            width: 100%;
            border-bottom: 1px solid #eee;
        }
        
        @media (max-width: 768px) {
            .ins-split { grid-template-columns: 1fr; }
        }

        .ins-col {
            padding: 20px;
        }

        .ins-col.ru { border-right: 1px solid #eee; background: #fff; }
        .ins-col.cn { background: #fafafa; }
        
        @media (max-width: 768px) {
            .ins-col.ru { border-right: none; border-bottom: 1px solid #eee; }
        }

        .ins-header {
            background: var(--primary);
            color: white;
            padding: 10px 20px;
            text-align: center;
            font-weight: bold;
        }

        .warning-box {
            background: #fff5f5;
            border-left: 4px solid var(--danger);
            padding: 10px;
            margin: 10px 0;
            font-size: 0.85em;
            color: #c0392b;
        }
        
        .example-box {
            background: #eef9f0;
            border-left: 4px solid var(--success);
            padding: 10px;
            margin: 10px 0;
            font-size: 0.85em;
        }

        .rate-list li {
            list-style-type: none;
            border-bottom: 1px dashed #eee;
            padding: 4px 0;
            display: flex;
            justify-content: space-between;
        }
        
        strong { color: var(--primary); }

        /* --- End Insurance Styles --- */

        .table-section { margin-top: 50px; }
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow);
        }
        th {
            background: #f8fafc;
            padding: 15px;
            text-align: left;
            font-size: 0.85rem;
            color: var(--text-light);
            text-transform: uppercase;
        }
        td {
            padding: 15px;
            border-top: 1px solid #f1f2f6;
        }
        tr.active-row {
            background: rgba(243, 156, 18, 0.1);
            font-weight: 700;
        }

        /* Print */
        #print-offer { display: none; }
        @media print {
            body * { visibility: hidden; }
            #print-offer, #print-offer * { visibility: visible; }
            #print-offer {
                display: block;
                position: absolute;
                left: 0; top: 0; width: 100%;
                background: white; color: black; padding: 40px;
            }
            .no-print { display: none !important; }
            .print-logo { height: 80px; margin-bottom: 10px; }
        }
        .print-head {
            display: flex;
            justify-content: space-between;
            border-bottom: 3px solid var(--primary);
            padding-bottom: 20px;
            margin-bottom: 30px;
        }
    </style>
</head>
<body>

<header class="no-print">
    <div class="banner-wrapper">
        <!-- Убедитесь, что файл картинки находится в той же папке -->
        <img src="66501.jpg" alt="Cargo 665 Banner" class="banner-image">
    </div>
</header>

<main class="container">
    <div class="app-grid no-print">
        <!-- Form Column -->
        <div class="card">
            <h2>
                Калькулятор стоимости
                <span class="cn">费用计算器</span>
            </h2>

            <div class="form-group">
                <label>Категория товаров <span class="cn">/ 货物类别</span></label>
                <select id="category" onchange="calc()">
                    <option value="cloth">Одежда / 服装 (30-35 d)</option>
                    <option value="taobao">Taobao / 淘宝 (25-40 d)</option>
                </select>
                <p style="font-size: 0.85rem; color: #e67e22; margin-top: 10px; font-weight: 600;">
                    * По вопросам других категорий (обувь, спецгруз и др.) — пожалуйста, обращайтесь к менеджеру.
                    <br><span class="cn">* 其他货物类别（鞋类、特殊货物等）请咨询客户经理。</span>
                </p>
            </div>

            <div class="grid-2">
                <div class="form-group">
                    <label>Вес <span class="cn">/ 重量</span></label>
                    <div class="input-box">
                        <input type="number" id="weight" value="20" min="10" step="0.1" oninput="calc()">
                        <span class="unit">kg</span>
                    </div>
                </div>
                <div class="form-group">
                    <label>Объем <span class="cn">/ 体积</span></label>
                    <div class="input-box">
                        <input type="number" id="volume" value="0.1" step="0.01" oninput="calc()">
                        <span class="unit">m³</span>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label>Дополнительно <span class="cn">/ 额外费用</span></label>
                <div class="checkbox-card">
                    <label class="check-item">
                        <input type="checkbox" id="spec_cargo" onchange="calc()">
                        <span>Электроника/Текстиль <br><span class="cn">电子/纺织 (+$0.2)</span></span>
                    </label>
                    <label class="check-item">
                        <input type="checkbox" id="replica" onchange="calc()">
                        <span>Реплики брендов <br><span class="cn">仿牌 (+$0.3)</span></span>
                    </label>
                </div>
            </div>

            <div class="form-group">
                <label>Базовая упаковка <span class="cn">/ 基本包装</span></label>
                <select id="pack" onchange="calc()">
                    <option value="4" selected>Скотч (Мешок) / 面单 (编织袋) ($4)</option>
                    <option value="5">Бумажные уголки / 纸护角 ($5)</option>
                    <option value="8">Деревянная обрешетка / 木架 ($8)</option>
                    <option value="30">Деревянный палет / 木托盘 ($30/m³)</option>
                    <option value="50">Деревянный ящик / 木箱 ($50/m³)</option>
                </select>
            </div>

            <div class="form-group">
                <label>Доп. защита (+$2) <span class="cn">/ 额外保护</span></label>
                <div class="checkbox-card">
                    <label class="check-item">
                        <input type="checkbox" id="pack_foam" onchange="calc()">
                        <span>Поролон <span class="cn">多规格 (海绵)</span></span>
                    </label>
                    <label class="check-item">
                        <input type="checkbox" id="pack_bubble" onchange="calc()">
                        <span>Пупырка <span class="cn">多规格 (气泡膜)</span></span>
                    </label>
                    <label class="check-item">
                        <input type="checkbox" id="pack_box" onchange="calc()">
                        <span>Коробка <span class="cn">多规格 (纸箱)</span></span>
                    </label>
                </div>
            </div>

            <!-- Insurance Section -->
            <div class="form-group">
                <label>Страхование груза <span class="cn">/ 货物保险</span></label>
                <div style="margin-bottom: 15px;">
                    <label class="check-item" style="width: 100%;">
                        <input type="checkbox" id="ins_check" onchange="toggleInsurance()">
                        <span>Застраховать груз <span class="cn">购买保险</span></span>
                    </label>
                </div>

                <div id="ins_input_block" class="ins-hidden">
                    <label style="font-size: 0.9em; margin-bottom: 5px;">Общая стоимость товара ($) / 货物总值</label>
                    <div class="input-box">
                        <input type="number" id="val_goods" placeholder="Например: 700" oninput="calc()">
                        <span class="unit">$</span>
                    </div>
                    <div style="margin-top: 8px; font-size: 0.9rem;">
                        Расчетная ставка / 费率: <b style="color: var(--accent);" id="ins_percent_display">0%</b>
                    </div>
                </div>

                <!-- BILINGUAL INSURANCE INFO (ACCORDION) -->
                <details class="ins-info-box">
                    <summary>Условия страхования / 保险条款</summary>
                    <div class="ins-header">СБОР СТРАХОВАНИЯ / 保险费用: 1-7%</div>
                    
                    <div class="ins-content">
                        <!-- Split View -->
                        <div class="ins-split">
                            <!-- Russian Column -->
                            <div class="ins-col ru">
                                <p><strong>1. Общие условия</strong></p>
                                <p>Страхование является добровольным (для товаров >500$ рекомендуем).</p>
                                <p>Возмещение выплачивается только за <strong>потерянный / украденный / конфискованный</strong> груз.</p>
                                <p>Ответственность перевозчика: доставка до г. Москва МКАД 19.</p>
                                
                                <div class="warning-box">
                                    ВАЖНО: мы не несем ответственность за повреждение или утрату товарного вида в пути. (См. раздел упаковки)
                                </div>
                                
                                <p><strong>2. Тарифы (Сумма ÷ Вес)</strong></p>
                                <ul class="rate-list">
                                    <li>1% - до 15 $/кг</li>
                                    <li>2% - 16-30 $/кг</li>
                                    <li>3% - 31-45 $/кг</li>
                                    <li>4% - 46-60 $/кг</li>
                                    <li>5% - 61-75 $/кг</li>
                                    <li>6% - 76-90 $/кг</li>
                                    <li>7% - 91-105 $/кг</li>
                                </ul>
                                <p style="font-size:0.8em; color:#7f8c8d;">*Выше 105$/кг - индивидуально.</p>

                                <div class="example-box">
                                    <strong>Пример расчета:</strong><br>
                                    Товар 700$, вес 20кг.<br>
                                    700 ÷ 20 = 35$ за кг → Ставка 3%<br>
                                    Страховка: 700$ * 3% = 21$
                                </div>

                                <p><strong>3. Компенсация</strong></p>
                                <p>При недостаче: исходя из средней цены за кг.</p>
                                <p>Без страховки: компенсация <strong>3$ за кг</strong>.</p>
                                <p style="margin-top:10px; font-size:0.8em; color:red;">*Не застрахованы бренды/запрещенные товары без уведомления — выплата 0.</p>
                            </div>

                            <!-- Chinese Column -->
                            <div class="ins-col cn">
                                <p><strong>1. 保险须知</strong></p>
                                <p>保险属于自愿性质（建议货值超过$500购买）。</p>
                                <p>赔偿仅针对<strong>丢失/被盗/被没收</strong>的货物。</p>
                                <p>承运人责任：仅负责运送至莫斯科 MKAD 19。</p>
                                
                                <div class="warning-box">
                                    重要提示：我们不对运输过程中的货物损坏或外观磨损负责。（请仔细阅读包装条款）
                                </div>
                                
                                <p><strong>2. 费率表 (总值 ÷ 重量)</strong></p>
                                <ul class="rate-list">
                                    <li>1% - $15/kg 以下</li>
                                    <li>2% - $16-30/kg</li>
                                    <li>3% - $31-45/kg</li>
                                    <li>4% - $46-60/kg</li>
                                    <li>5% - $61-75/kg</li>
                                    <li>6% - $76-90/kg</li>
                                    <li>7% - $91-105/kg</li>
                                </ul>
                                <p style="font-size:0.8em; color:#7f8c8d;">*超过$105/kg需单独协商。</p>

                                <div class="example-box">
                                    <strong>计算示例：</strong><br>
                                    货值$700，重量20kg。<br>
                                    700 ÷ 20 = $35/kg → 费率 3%<br>
                                    保费：$700 * 3% = $21
                                </div>

                                <p><strong>3. 赔偿标准</strong></p>
                                <p>货物短少：按每公斤平均价值赔偿。</p>
                                <p>未投保：丢失赔偿 <strong>$3/kg</strong>。</p>
                                <p style="margin-top:10px; font-size:0.8em; color:red;">*若未申报品牌/违禁品，保险将不予赔付。</p>
                            </div>
                        </div>
                        
                        <!-- Avia Section (Full Width) -->
                        <div style="padding: 15px; background: #fffde7; border-top: 1px solid #eee; font-size: 0.85em;">
                            <strong>Для Авиа-Экспресс / 航空快递保险:</strong><br>
                            $200 - 1% | $200~400 - 2% | $400~600 - 3% | $600~800 - 4% | $800~1000 - 5% | >$1000 - 6%
                        </div>
                    </div>
                </details>
            </div>
        </div>

        <!-- Result Column -->
        <div class="card result-panel">
            <div class="total-label">Итого к оплате / 总费用</div>
            <div class="total-amount" id="res_total">$0.00</div>

            <div class="breakdown">
                <div class="row">
                    <span class="lbl">Плотность / 密度</span>
                    <span class="val" id="res_dens">0 kg/m³</span>
                </div>
                <div class="row">
                    <span class="lbl">Тариф / 单价</span>
                    <span class="val" id="res_rate">$0.00</span>
                </div>
                <div class="row">
                    <span class="lbl">Доставка / 运费</span>
                    <span class="val" id="res_ship">$0.00</span>
                </div>
                <div class="row">
                    <span class="lbl">Упаковка / 包装</span>
                    <span class="val" id="res_pack">$0.00</span>
                </div>
                <div class="row">
                    <span class="lbl">Страховка / 保险</span>
                    <span class="val" id="res_ins">$0.00</span>
                </div>
            </div>

            <button class="btn-print" onclick="window.print()">
                Печать КП / 打印报价单
            </button>
            
            <p style="font-size: 0.7rem; color: #7f8c8d; margin-top: 15px; text-align: center;">
                *Минимальный вес 10кг. / 最低重量 10 公斤
            </p>
        </div>
    </div>

    <!-- Tables -->
    <div class="table-section no-print">
        <h2 style="margin-top: 40px;">Тарифная сетка / 价格表</h2>
        <div style="overflow-x: auto;">
            <table id="tariff_table">
                <thead>
                    <tr>
                        <th>Плотность / 密度 (kg/m³)</th>
                        <th>Цена / 价格 ($/kg)</th>
                        <th>Примечание / 备注</th>
                    </tr>
                </thead>
                <tbody id="table_body"></tbody>
            </table>
        </div>
    </div>
</main>

<!-- PRINT TEMPLATE -->
<div id="print-offer">
    <div class="print-head">
        <div>
            <img src="66501.jpg" alt="Logo" class="print-logo">
            <p>Commercial Offer / 商业报价单</p>
        </div>
        <div style="text-align: right;">
            <p>Date: <span id="p_date"></span></p>
            <p>Contacts: +7 (916) 028-12-61</p>
        </div>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-top: 30px;">
        <div>
            <h3>Cargo Details / 货物详情</h3>
            <hr style="margin: 10px 0;">
            <p>Category / 类别: <b id="p_cat"></b></p>
            <p>Weight / 重量: <b id="p_weight"></b> kg</p>
            <p>Volume / 体积: <b id="p_vol"></b> m³</p>
            <p>Density / 密度: <b id="p_dens"></b> kg/m³</p>
            <p>Cargo Value / 货值: <b id="p_goods_val"></b></p>
        </div>
        <div>
            <h3>Final Quote / 最终报价</h3>
            <hr style="margin: 10px 0;">
            <p>Shipping / 运费: <b id="p_ship"></b></p>
            <p>Packaging / 包装: <b id="p_pack"></b></p>
            <p>Insurance (<span id="p_ins_rate">0%</span>) / 保险: <b id="p_ins"></b></p>
            <h2 style="color: #f39c12; margin-top: 15px;">TOTAL: <span id="p_total"></span></h2>
        </div>
    </div>
    
    <div style="margin-top: 40px; font-size: 0.8em; color: #555; border-top: 1px solid #000; padding-top: 10px;">
        <p><strong>Insurance Policy / Страхование:</strong> Lost/Stolen goods only. No liability for damage. Deductible for undeclared brands applies.</p>
        <p><strong>Uninsured Cargo:</strong> Compensation $3/kg for loss.</p>
    </div>
</div>

<script>
    // --- DATABASE ---
    const DATA = {
        cloth: [
            {m:300, x:9999, p:3.20},
            {m:250, x:300, p:3.30},
            {m:200, x:250, p:3.40},
            {m:190, x:200, p:3.50},
            {m:180, x:190, p:3.60},
            {m:170, x:180, p:3.70},
            {m:160, x:170, p:3.80},
            {m:150, x:160, p:3.90},
            {m:140, x:150, p:4.00},
            {m:130, x:140, p:4.10},
            {m:120, x:130, p:4.20},
            {m:110, x:120, p:4.30},
            {m:100, x:110, p:4.40},
            {m:0, x:100, p:460, v:true} // Volumetric rate
        ],
        taobao: [
            {m:0, x:9999, p:7.0} // Simplified for example
        ]
    };

    function toggleInsurance() {
        const isChecked = document.getElementById('ins_check').checked;
        const block = document.getElementById('ins_input_block');
        block.style.display = isChecked ? 'block' : 'none';
        if (!isChecked) {
            document.getElementById('val_goods').value = '';
        }
        calc();
    }

    // UPDATED LOGIC per instruction:
    // Rate = Value / Weight
    // <=15: 1%, <=30: 2%, <=45: 3%, <=60: 4%, <=75: 5%, <=90: 6%, <=105: 7%
    function getInsuranceRate(val, weight) {
        if (weight <= 0 || val <= 0) return 0;
        
        const costPerKg = val / weight;
        
        if (costPerKg <= 15) return 0.01;
        if (costPerKg <= 30) return 0.02;
        if (costPerKg <= 45) return 0.03;
        if (costPerKg <= 60) return 0.04;
        if (costPerKg <= 75) return 0.05;
        if (costPerKg <= 90) return 0.06;
        if (costPerKg <= 105) return 0.07;
        
        // > 105 (Individual) - keeping at 7% for calculator safety or 
        // you can return a higher warning value.
        return 0.07; 
    }

    function calc() {
        const cat = document.getElementById('category').value;
        const w = parseFloat(document.getElementById('weight').value) || 0;
        const v = parseFloat(document.getElementById('volume').value) || 0;
        const isSpec = document.getElementById('spec_cargo').checked;
        const isRep = document.getElementById('replica').checked;
        
        // Packaging inputs
        const packVal = parseFloat(document.getElementById('pack').value);
        const hasFoam = document.getElementById('pack_foam').checked;
        const hasBubble = document.getElementById('pack_bubble').checked;
        const hasBox = document.getElementById('pack_box').checked;

        // Insurance inputs
        const isInsured = document.getElementById('ins_check').checked;
        const goodsVal = parseFloat(document.getElementById('val_goods').value) || 0;
        
        if (w < 1) return; // Prevent division by zero or empty

        // 1. Calculate Density
        const density = v > 0 ? w / v : 0;
        
        // 2. Find Tariff
        const tiers = DATA[cat];
        let tier = tiers.find(t => density >= t.m && density < t.x) || tiers[tiers.length - 1];

        let rate = tier.p;
        // Add surcharges
        if (isSpec) rate += 0.2;
        if (isRep) rate += 0.3;

        // Calculate Base Shipping
        const shipCost = tier.v ? (v * rate) : (w * rate);
        
        // 3. Packaging Calculation
        let packCost = 0;
        if (packVal === 30 || packVal === 50) {
            packCost = v * packVal; // Pallets/Crates by volume
        } else {
            packCost = packVal; // Simple packaging flat fee (per piece logic simplified here)
        }
        // Add extras ($2 each)
        if (hasFoam) packCost += 2;
        if (hasBubble) packCost += 2;
        if (hasBox) packCost += 2;

        // 4. Insurance Calculation
        let insPct = 0;
        let insCost = 0;
        
        if (isInsured && goodsVal > 0) {
            insPct = getInsuranceRate(goodsVal, w);
            insCost = goodsVal * insPct;
        }

        // TOTAL
        const total = shipCost + packCost + insCost;

        // UI Updates
        document.getElementById('res_total').innerText = '$' + total.toFixed(2);
        document.getElementById('res_dens').innerText = density.toFixed(1) + ' kg/m³';
        document.getElementById('res_rate').innerText = '$' + rate.toFixed(2) + (tier.v ? '/m³' : '/kg');
        document.getElementById('res_ship').innerText = '$' + shipCost.toFixed(2);
        document.getElementById('res_pack').innerText = '$' + packCost.toFixed(2);
        document.getElementById('res_ins').innerText = '$' + insCost.toFixed(2);
        
        // Update Insurance Percentage Text
        const pctDisplay = (insPct * 100).toFixed(0) + '%';
        const costPerKg = (w > 0 && goodsVal > 0) ? (goodsVal/w).toFixed(1) : 0;
        
        // Update display text for rate
        let insText = pctDisplay;
        if (isInsured && goodsVal > 0 && costPerKg > 105) {
             insText += " (Indiv.)";
             document.getElementById('ins_percent_display').style.color = 'red';
        } else {
             document.getElementById('ins_percent_display').style.color = '#f39c12';
        }
        document.getElementById('ins_percent_display').innerText = insText;

        // Render Table & Print Data
        renderTable(cat, density);
        updatePrint(cat, w, v, density, shipCost, packCost, insCost, total, goodsVal, pctDisplay);
    }

    function renderTable(cat, currentDens) {
        const body = document.getElementById('table_body');
        body.innerHTML = '';
        DATA[cat].forEach(t => {
            const tr = document.createElement('tr');
            if (currentDens >= t.m && currentDens < t.x) tr.className = 'active-row';
            const range = t.x > 5000 ? `>${t.m}` : `${t.m}-${t.x}`;
            tr.innerHTML = `
                <td>${range}</td>
                <td>$${t.p}${t.v ? '/m³' : ''}</td>
                <td>${t.v ? 'Объемный тариф / 体积价格' : 'По весу / 按重量'}</td>
            `;
            body.appendChild(tr);
        });
    }

    function updatePrint(cat, w, v, d, ship, pack, ins, total, gVal, insRateTxt) {
        const names = {cloth:'Одежда / 服装', taobao:'Taobao'};
        document.getElementById('p_date').innerText = new Date().toLocaleDateString();
        document.getElementById('p_cat').innerText = names[cat] || cat;
        document.getElementById('p_weight').innerText = w;
        document.getElementById('p_vol').innerText = v;
        document.getElementById('p_dens').innerText = d.toFixed(1);
        document.getElementById('p_ship').innerText = '$' + ship.toFixed(2);
        document.getElementById('p_pack').innerText = '$' + pack.toFixed(2);
        document.getElementById('p_ins').innerText = '$' + ins.toFixed(2);
        document.getElementById('p_total').innerText = '$' + total.toFixed(2);
        document.getElementById('p_goods_val').innerText = gVal > 0 ? '$' + gVal : 'No Insurance';
        document.getElementById('p_ins_rate').innerText = ins > 0 ? insRateTxt : '0%';
    }

    // Init
    window.onload = calc;
</script>

</body>
</html>
